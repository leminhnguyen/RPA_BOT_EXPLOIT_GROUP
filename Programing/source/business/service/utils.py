import os
import sys

import utils.fix_errors.fix_qt_import_error
import win32.win32clipboard as win32clipboard
from PyQt5 import QtGui, QtCore, QtWidgets
from PyQt5.QtWidgets import QApplication, QMessageBox
import openpyxl


def get_excel_file(caption="Excel files", directory='.'):
    """
    locate folder containning excel file
    """
    widget = QtWidgets.QWidget(flags=QtCore.Qt.WindowStaysOnTopHint)
    filename, _ = QtWidgets.QFileDialog.getOpenFileName(
        widget,
        directory=directory,
        caption=caption,
        filter='Excel files (*.xlsx)'
    )
    return filename


def get_resource_path(relative_path, type_=""):
    """ get absolute path to resource """
    try:
        base_path = sys._MEIPASS  # for Pyinstaller
    except Exception:
        base_path = os.path.join('Programing\\assets', type_)  # for dev
    return os.path.abspath(os.path.join(base_path, relative_path))


def dict_get_multikeys(dict_, *keys, default=None):
    for key in keys:
        if key in dict_:
            return dict_[key]
    return default


def show_message(title, info, type_=QMessageBox.Information):
    """ show message """
    QApplication.instance()
    message_box = QMessageBox()
    message_box.setText(info)
    message_box.setWindowTitle(title)
    message_box.setWindowIcon(QtGui.QIcon(Path.ICON_PATH))
    message_box.setWindowFlags(QtCore.Qt.WindowStaysOnTopHint)
    message_box.setIcon(type_)
    message_box.activateWindow()
    message_box.exec_()


def get_saved_paths():
    """ get file path that user used last time """
    if not os.path.isfile(Path.SAVED_PATH) or os.stat(Path.SAVED_PATH).st_size == 0:
        return ''

    with open(Path.SAVED_PATH, encoding='utf-8', mode='r') as f:
        path = f.read()
    return path


def save_paths(new_path):
    """ save the path user use """
    with open(Path.SAVED_PATH, encoding='utf-8', mode='w') as f:
        f.write(new_path)


def as_text(value):
    """ convert arbitrary value to string """
    return str(value) if value is not None else ""


def remove_qt_temporary_files():
    if os.path.exists('qt.conf'):
        os.remove('qt.conf')


def get_clipboard_data():
    win32clipboard.OpenClipboard()
    data = win32clipboard.GetClipboardData()
    win32clipboard.EmptyClipboard()
    win32clipboard.CloseClipboard()
    return data


def clear_clipboard():
    try:
        win32clipboard.OpenClipboard()
        win32clipboard.EmptyClipboard()
        win32clipboard.CloseClipboard()
    except Exception:
        pass

def format_sheet(filename: str="", sheet: str=""):
    """ bold header and resize column width with length of largest cell """
    wb = openpyxl.load_workbook(filename)
    ws = wb.get_sheet_by_name(sheet)

    for row in ws.iter_rows(min_row=1, min_col=1, max_row=1, max_col=ws.max_column):
        for cell in row:
            cell.font = cell.font.copy(bold=True)

    for column_cells in ws.columns:
        length = max(len(as_text(cell.value)) for cell in column_cells)
        ws.column_dimensions[column_cells[0].column].width = length+1

    wb.save(filename)
    wb.close()



class Path:
    ICON_PATH = get_resource_path("ac_solution.ico", type_="image")
    IMG_PATH = get_resource_path("ac_solution.jpg", type_="image")
    QSS_PATH = get_resource_path("style_sheet.qss", type_="file")
    SAVED_PATH = get_resource_path("saved_paths.txt", type_="file")
    STATUS_PATH = get_resource_path("status_summary.xlsx", type_="file")
    BOT_ROOT_FOLDER = os.path.join(
        dict_get_multikeys(os.environ, "LOCALAPPDATA", "USERPROFILE", "TEMP", "TMP", os.getcwd()),
        "AC_SOLUTION",
    )
    CHROME_DRIVER_PATH = os.path.join(BOT_ROOT_FOLDER, "ChromeDriver")