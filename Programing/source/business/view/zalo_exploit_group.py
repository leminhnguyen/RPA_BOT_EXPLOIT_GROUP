import os
import sys

import utils.fix_errors.fix_qt_import_error
from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QMessageBox

import utils.fix_errors.logging_uncaught_exception
from business.controller.main_controller import MainController
from business.entity.exceller import Exceller
from business.entity.zalo_broadcast_nick import BroadcastNick
from business.exception.exception import FileNotBeSelectedException
from business.service.utils import (Path, get_excel_file, get_saved_paths,
                                    save_paths, show_message)
from utils.license.license_checker import LicenseChecker, LicenseCode
from utils.parallel_locker import ParallelLoker

sys.path.append("Programing\\source")




class Ui_Form(object):
    def __init__(self, form: QtWidgets=None, brdcst: BroadcastNick=None):
        self.setupUi(form)
        self.brdcst = brdcst
        self.trigger()
        self.controller = None

    def trigger(self):
        # button
        self.button_nick_zalo.clicked.connect(self.choose_group_file)
        self.button_gui_tn.clicked.connect(self.send_mess)
        self.button_cap_nhat_trang_thai.clicked.connect(self.update_status)
        self.button_xem_file.clicked.connect(self.open_status)

        # lineedit
        self.path = get_saved_paths()
        if self.path:
            self.lineEdit_nick_zalo.setText(self.path)
        else:
            self.lineEdit_nick_zalo.setPlaceholderText("Chon file du lieu")
        
    def setupUi(self, Form):
        Form.setObjectName("Form")
        Form.resize(850, 500)
        Form.setStyleSheet(open(Path.QSS_PATH, mode='r', encoding='utf-8').read())

        self.frame_main = QtWidgets.QFrame(Form)
        self.frame_main.setGeometry(QtCore.QRect(10, 0, 831, 491))
        self.frame_main.setStyleSheet("")
        self.frame_main.setFrameShape(QtWidgets.QFrame.StyledPanel)
        self.frame_main.setFrameShadow(QtWidgets.QFrame.Raised)
        self.frame_main.setObjectName("frame_main")

        self.frame_btn_chon_file = QtWidgets.QFrame(self.frame_main)
        self.frame_btn_chon_file.setGeometry(QtCore.QRect(640, 250, 161, 121))
        self.frame_btn_chon_file.setStyleSheet("")
        self.frame_btn_chon_file.setFrameShape(QtWidgets.QFrame.StyledPanel)
        self.frame_btn_chon_file.setFrameShadow(QtWidgets.QFrame.Raised)
        self.frame_btn_chon_file.setObjectName("frame_btn_chon_file")

        self.button_nick_zalo = QtWidgets.QPushButton(self.frame_btn_chon_file)
        self.button_nick_zalo.setGeometry(QtCore.QRect(10, 40, 141, 51))
        font = QtGui.QFont()
        font.setPointSize(-1)
        self.button_nick_zalo.setFont(font)
        self.button_nick_zalo.setStyleSheet("")
        self.button_nick_zalo.setObjectName("button_nick_zalo")

        self.frame_btn_gui_tn = QtWidgets.QFrame(self.frame_main)
        self.frame_btn_gui_tn.setGeometry(QtCore.QRect(30, 380, 771, 91))
        self.frame_btn_gui_tn.setStyleSheet("")
        self.frame_btn_gui_tn.setFrameShape(QtWidgets.QFrame.StyledPanel)
        self.frame_btn_gui_tn.setFrameShadow(QtWidgets.QFrame.Raised)
        self.frame_btn_gui_tn.setObjectName("frame_btn_gui_tn")

        self.button_cap_nhat_trang_thai = QtWidgets.QPushButton(self.frame_btn_gui_tn)
        self.button_cap_nhat_trang_thai.setGeometry(QtCore.QRect(160, 20, 151, 51))
        font = QtGui.QFont()
        font.setPointSize(-1)
        self.button_cap_nhat_trang_thai.setFont(font)
        self.button_cap_nhat_trang_thai.setStyleSheet("")
        self.button_cap_nhat_trang_thai.setObjectName("button_cap_nhat_trang_thai")

        self.button_xem_file = QtWidgets.QPushButton(self.frame_btn_gui_tn)
        self.button_xem_file.setGeometry(QtCore.QRect(320, 20, 141, 51))
        font = QtGui.QFont()
        font.setPointSize(-1)
        self.button_xem_file.setFont(font)
        self.button_xem_file.setStyleSheet("")
        self.button_xem_file.setObjectName("button_xem_file")

        self.button_gui_tn = QtWidgets.QPushButton(self.frame_btn_gui_tn)
        self.button_gui_tn.setGeometry(QtCore.QRect(620, 20, 141, 51))
        font = QtGui.QFont()
        font.setPointSize(-1)
        self.button_gui_tn.setFont(font)
        self.button_gui_tn.setStyleSheet("")
        self.button_gui_tn.setObjectName("button_gui_tn")

        self.frame_lineEdit_file = QtWidgets.QFrame(self.frame_main)
        self.frame_lineEdit_file.setGeometry(QtCore.QRect(30, 250, 591, 121))
        self.frame_lineEdit_file.setFrameShape(QtWidgets.QFrame.StyledPanel)
        self.frame_lineEdit_file.setFrameShadow(QtWidgets.QFrame.Raised)
        self.frame_lineEdit_file.setObjectName("frame_lineEdit_file")

        self.lineEdit_nick_zalo = QtWidgets.QLineEdit(self.frame_lineEdit_file)
        font = QtGui.QFont()
        font.setPointSize(10)
        self.lineEdit_nick_zalo.setFont(font)
        self.lineEdit_nick_zalo.setGeometry(QtCore.QRect(20, 40, 561, 51))
        self.lineEdit_nick_zalo.setStyleSheet("")
        self.lineEdit_nick_zalo.setText("")
        self.lineEdit_nick_zalo.setReadOnly(True)
        self.lineEdit_nick_zalo.setObjectName("lineEdit_nick_zalo")

        self.label_nick_zalo = QtWidgets.QLabel(self.frame_lineEdit_file)
        self.label_nick_zalo.setGeometry(QtCore.QRect(20, 0, 311, 31))
        self.label_nick_zalo.setObjectName("label_nick_zalo")

        self.frame_label_image = QtWidgets.QFrame(self.frame_main)
        self.frame_label_image.setGeometry(QtCore.QRect(20, 10, 781, 191))
        self.frame_label_image.setFrameShape(QtWidgets.QFrame.StyledPanel)
        self.frame_label_image.setFrameShadow(QtWidgets.QFrame.Raised)
        self.frame_label_image.setObjectName("frame_label_image")

        self.zalo_botchat = QtWidgets.QLabel(self.frame_label_image)
        self.zalo_botchat.setGeometry(QtCore.QRect(20, 140, 721, 51))
        font = QtGui.QFont()
        font.setFamily("Roboto")
        font.setPointSize(-1)
        font.setItalic(False)
        self.zalo_botchat.setFont(font)
        self.zalo_botchat.setStyleSheet("")
        self.zalo_botchat.setAlignment(QtCore.Qt.AlignCenter)
        self.zalo_botchat.setObjectName("zalo_botchat")

        self.image_AC_solution = QtWidgets.QLabel(self.frame_label_image)
        self.image_AC_solution.setGeometry(QtCore.QRect(270, -10, 211, 151))
        self.image_AC_solution.setStyleSheet("")
        self.image_AC_solution.setText("")
        self.image_AC_solution.setTextFormat(QtCore.Qt.AutoText)
        self.image_AC_solution.setPixmap(QtGui.QPixmap(Path.IMG_PATH))
        self.image_AC_solution.setScaledContents(True)
        self.image_AC_solution.setAlignment(QtCore.Qt.AlignCenter)
        self.image_AC_solution.setTextInteractionFlags(QtCore.Qt.NoTextInteraction)
        self.image_AC_solution.setObjectName("image_AC_solution")

        self.retranslateUi(Form)
        QtCore.QMetaObject.connectSlotsByName(Form)

    def retranslateUi(self, Form):
        _translate = QtCore.QCoreApplication.translate
        Form.setWindowTitle(_translate("Form", "ZALO SENDS GOOGLESHEET DATA"))
        self.button_nick_zalo.setToolTip(_translate("Form", "<html><head/><body><p><br/></p></body></html>"))
        self.button_nick_zalo.setText(_translate("Form", "Chọn file"))
        self.button_cap_nhat_trang_thai.setText(_translate("Form", "Cập nhật trạng thái"))
        self.button_xem_file.setText(_translate("Form", "Xem trạng thái"))
        self.button_gui_tn.setText(_translate("Form", "Gửi tin nhắn"))
        self.label_nick_zalo.setText(_translate("Form", "Chon file chua ket qua khai thac"))
        self.zalo_botchat.setText(_translate("Form", "<html><head/><body><p><span style=\" color:#aa00ff;\">ZALO KET QUA KHAI THAC NHOM</span></p></body></html>"))

    def send_mess(self):
        if not self.path:
            show_message("LOI", "Ban chua chon file chua du lieu", type_=QMessageBox.Critical)
            return
        with Exceller(self.path) as exceller:
            self.controller = MainController(brdst_nick=self.brdcst, exceller=exceller)
            self.controller.run()

    def choose_group_file(self):
        path = get_excel_file("Chon file excel chua du lieu can gui")
        if path:
            self.lineEdit_nick_zalo.setText(path)
        else:
            self.lineEdit_nick_zalo.setPlaceholderText("Chon file du lieu")
        self.path = path
        save_paths(path)

    def open_status(self):
        try:
            os.startfile(Path.STATUS_PATH)
        except FileNotFoundError:
            show_message("LỖI", "Hiện tại chưa có file tổng hợp kết quả")

    def update_status(self):
        if not os.path.isfile(Path.STATUS_PATH):
            show_message("LỖI", "Hiện tại chưa có file tổng hợp kết quả")
            return
        if not self.controller:
            self.controller = MainController(brdst_nick=self.brdcst)
        self.controller.update(Path.STATUS_PATH)


class Execute:
    def __init__(self, mphone: str="", mpass: str="", nickname: str=""):
        self.brdcst = BroadcastNick(phone=mpass, password=mpass, nickname=nickname)

    def run(self):   
        try:
            app = QtWidgets.QApplication.instance()
            Form = QtWidgets.QWidget()
            Form.setWindowIcon(QtGui.QIcon(Path.ICON_PATH))
            ui = Ui_Form(form=Form, brdcst=self.brdcst)
            Form.show()
            return_value = app.exec_()
            return return_value
        except Exception:
            pass
