import time
from win32com.client import Dispatch

import pandas

from business.entity.zalo_nick import ZaloNick, BroadcastNick
from business.entity.exceller import Exceller
import utils.fix_errors.logging_uncaught_exception

FILENAME = r"D:\Documents\UNIVERSITY\PROJECT\Python_RPA\bot-exploit-group\Requirements\Link_Gốc_NHÓM.xlsx"


class MainController:
    def __init__(self, brdst_nick: BroadcastNick, exceller: Exceller):
        self.brdst_nick = brdst_nick
        self.exceller = exceller

    def send_mess(self):
        gap = Exceller.get_group_and_phone(filename=FILENAME, sheetname="BAN_ZALO_AUTO")
        self.brdst_nick.login()
        time.sleep(1)
        for gname, phone in gap.items():
            nick = ZaloNick(phone=phone, nickname=gname)
            self.brdst_nick.send_data(nick=nick, sheetname=gname, excel_reader=self.exceller)

    def get_status(self):
        self.brdst_nick.get_status_of_all()

    def record_status(self):
        nicks = self.brdst_nick.nicks
        status = [nick.get_infor() for nick in nicks]
        df = pandas.DataFrame(status, columns=status[0].keys())
        df.to_excel("status_summary.xlsx", index=False, sheet_name="SUMMARY")

    def run(self):
        self.send_mess()
        self.get_status()
        self.record_status()


if __name__ == '__main__':
    # setup
    brdcst = BroadcastNick('0382334747', '123456', "Le Minh Nguyen")

    # use context manager to release resource automatically
    with Exceller(FILENAME) as exceller:
        mctrl = MainController(brdst_nick=brdcst, exceller=exceller)
        mctrl.run()
