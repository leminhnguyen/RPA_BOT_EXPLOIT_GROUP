import time
from win32com.client import Dispatch
import sys
sys.path.append("Programing\\source")

import pandas
from webdrivermanager import ChromeDriverManager

from business.entity.zalo_broadcast_nick import BroadcastNick
from business.entity.zalo_customer_nick import ZaloNick
from business.entity.exceller import Exceller
import utils.fix_errors.logging_uncaught_exception
from business.service.utils import show_message, Path, format_sheet

FILENAME = r"D:\Documents\UNIVERSITY\PERSONAL\PROJECT\RPA\Python_RPA\bot-exploit-group\Requirements\Link_Gốc_NHÓM.xlsx"


class MainController:

    def __init__(self, brdst_nick: BroadcastNick, exceller: Exceller=None):
        self.brdst_nick = brdst_nick
        self.exceller = exceller

    def send_mess(self):
        gap = Exceller.get_group_and_phone(filename=FILENAME, sheetname="BAN_ZALO_AUTO")
        try:
            if self.brdst_nick.driver.current_url != BroadcastNick.ZALO_LOGIN:
                self.brdst_nick.login()
        except AttributeError:
            self.brdst_nick.login()
        time.sleep(1)
        self.brdst_nick.nicks = []
        for gname, phone in gap.items():
            nick = ZaloNick(phone=phone, nickname=gname)
            self.brdst_nick.send_data(nick=nick, sheetname=gname, excel_reader=self.exceller)

    def get_status(self):
        self.brdst_nick.get_status_of_all()

    def record_status(self):
        nicks = self.brdst_nick.nicks
        status = [nick.get_infor() for nick in nicks]
        df = pandas.DataFrame(status, columns=status[0].keys())
        df.to_excel(Path.STATUS_PATH, index=False, sheet_name="SUMMARY")

    def run(self):
        self.send_mess()
        self.get_status()
        self.record_status()
        format_sheet(filename=Path.STATUS_PATH, sheet="SUMMARY")
        show_message("THÔNG BÁO", "Đã gửi xong tin nhắn, bạn vui lòng check lại trạng thái gửi tin")

    def update(self, filename: str, sheetname: str = "SUMMARY"):
        self.brdst_nick.update_status_of_all(filename, sheetname)
        self.record_status()
        format_sheet(filename=Path.STATUS_PATH, sheet="SUMMARY")
        show_message("THÔNG BÁO", "Đã cập nhật xong trạng thái tin nhắn, bạn vui lòng check lại trạng thái gửi tin")


if __name__ == '__main__':
    import os
    # hiding personal information
    mphone = os.environ.get('MY_PHONE')
    mpass = os.environ.get('MY_PASS')
    print(mphone, mpass)
    brdcst = BroadcastNick(phone=mpass, password=mpass, nickname="Le Minh Nguyen")

    # use context manager to release resource automatically
    with Exceller(FILENAME) as exceller:
        print(exceller)
        mctrl = MainController(brdst_nick=brdcst, exceller=exceller)
        mctrl.run()
