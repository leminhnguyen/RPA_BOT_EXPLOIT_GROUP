import time

from win32com.client import Dispatch

from business.entity.zalo_nick import ZaloNick, BroadcastNick
from business.entity.excel_reader import ExcelReader

import utils.fix_errors.logging_uncaught_exception

FILENAME = r"D:\Documents\UNIVERSITY\PROJECT\Python_RPA\bot-exploit-group\Requirements\Link_Gốc_NHÓM.xlsx"


class MainController:
    def __init__(self, brdst_nick: BroadcastNick, excel_reader: ExcelReader):
        self.brdst_nick = brdst_nick
        self.excel_reader = excel_reader

    def send_mess(self):
        gap = ExcelReader.get_group_and_phone(filename=self.excel_reader.filename, sheetname="BAN_ZALO_AUTO")
        self.brdst_nick.login()
        time.sleep(1)
        for gname, phone in gap.items():
            nick = ZaloNick(phone=phone)
            mess = ""
            self.brdst_nick.send_data(nick=nick, message=mess, sheetname=gname, excel_reader=self.excel_reader)

    def get_status(self):


if __name__ == '__main__':
    # setup
    brdcst = BroadcastNick('0382334747', '123456')
    excel = ExcelReader(FILENAME)
    # setup workbook for excel reader
    excel_app = Dispatch("Excel.Application")
    excel_app.DisplayAlerts = False
    try:
        excel.workbook = excel_app.WorkBooks.Open(FILENAME)
        # run
        mctrl = MainController(brdst_nick=brdcst, excel_reader=excel)
        mctrl.send_mess()
    finally:
        # close workbook
        del excel.workbook
