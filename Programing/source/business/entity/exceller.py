from typing import List

import openpyxl
import win32.win32clipboard as win32clipboard
from openpyxl import Workbook
from openpyxl.worksheet import Worksheet
from openpyxl.utils.cell import get_column_letter
from win32com.client import Dispatch

from business.service.utils import get_clipboard_data, as_text
from business.entity.zalo_customer_nick import ZaloNick


class Exceller:

    def __init__(self, filename: str):
        self.filename = filename
        self.excel_app = Dispatch("Excel.Application")

    def __enter__(self):
        self.excel_app.DisplayAlerts = False
        self._workbook = self.excel_app.WorkBooks.Open(self.filename)
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        try:
            if self._workbook:
                self._workbook.Close(True)
        except AttributeError:
            pass

    @staticmethod
    def get_group_and_phone(filename: str, sheetname: str):
        wb = openpyxl.load_workbook(filename)
        ws = wb[sheetname]
        gap = dict()
        for row in ws.iter_rows(min_row=2, max_row=ws.max_row, min_col=1, max_col=1):
            groupname, phone = ws["A" + str(row[0].row)].value, ws["B" + str(row[0].row)].value
            if phone not in ["", None]:
                gap.update({groupname: phone})
        wb.close()
        return gap

    @staticmethod
    def get_updating_nicks(filename: str, sheetname: str) -> List[ZaloNick]:
        wb = openpyxl.load_workbook(filename)
        ws = wb[sheetname]
        unicks = []
        for idx in range(2, ws.max_row+1):
            cells = [cell.value for cell in ws[idx]]
            print(cells[0])
            unick = ZaloNick(cells[0], cells[1], *cells[2::])
            unicks.append(unick)
        return unicks

    @staticmethod
    def _get_last_row(ws: Worksheet, col: str) -> str:
        """ get last not empty row """
        row = ws.max_row
        while ws[col + str(row)].value in [None, ""]:
            row -= 1
        return str(row)

    def _get_used_range(self, sheetname: str) -> str:
        """ return the last row which is not empty"""
        wb = ExcelSingleton.get_instance(self.filename).workbook
        ws = wb[sheetname]
        last_row = self._get_last_row(ws, 'B')
        return 'B1:' + get_column_letter(ws.max_column) + last_row

    def copy_used_range(self, sheetname: str):
        ws = self._workbook.Worksheets(sheetname)
        ws.Range(self._get_used_range(sheetname)).Copy()
        print("copied")


class MyWorkbook:
    def __init__(self, filename: str):
        self.filename = filename
        self.workbook: Workbook = openpyxl.load_workbook(filename, data_only=True)


class ExcelSingleton:
    _instances: List[MyWorkbook] = []

    @classmethod
    def get_instance(cls, filename: str) -> MyWorkbook:
        for instance in cls._instances:
            if filename == instance.filename:
                return instance
        else:
            new_instance = MyWorkbook(filename)
            cls._instances.append(new_instance)
            return new_instance


# exl = ExcelReader(r"D:\Documents\UNIVERSITY\PROJECT\Python_RPA\bot-exploit-group\Bussiness\Link_Gốc_NHÓM.xlsx")
# print(exl.copy_used_range('Nhóm Đại Phát - MCA'))
# # get clipboard data
# win32clipboard.OpenClipboard()
# data = win32clipboard.GetClipboardData()
# win32clipboard.EmptyClipboard()
# win32clipboard.CloseClipboard()
# print(data)

# filename = r"D:\Documents\UNIVERSITY\PROJECT\Python_RPA\bot-exploit-group\Bussiness\Link_Gốc_NHÓM.xlsx"
# x1 = ExcelSingleton.get_instance(filename)
# x2 = ExcelSingleton.get_instance(filename)
# x3 = ExcelSingleton.get_instance(filename)
# x4 = ExcelSingleton.get_instance(filename)
# print(id(x1))
# print(id(x2))
# print(id(x3))
# print(id(x4))
