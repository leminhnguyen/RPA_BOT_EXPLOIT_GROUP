import os
import time
from typing import List

import pyperclip
from selenium import webdriver
from selenium.common.exceptions import NoSuchElementException, JavascriptException
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from PyQt5.QtWidgets import QMessageBox
from selenium.webdriver.common.keys import Keys

from business.entity.excel_reader import ExcelReader
from business.service.utils import Path, clear_clipboard
from utils.chromedriver import ChromeDriver
from business.service.utils import show_message
from business.exception.exception import ZaloRequestExceedingException, ZaloNotFoundException


class ZaloNick:
    def __init__(self, phone: str):
        self.phone = phone
        self._nickname: str = ""
        self.contact_found: bool = True
        self.status = {'Ngày giờ gửi tin': '', 'Trạng thái gửi tin': '', 'Ngày giờ trạng thái (nếu có)': '', 'Ghi chú': ''}

    @property
    def nickname(self):
        return self._nickname

    @nickname.setter
    def nickname(self, nickname: str):
        self._nickname = nickname

    def show_infor(self):
        print(f"phone: {self.phone}")
        print(f"nickname: {self.nickname}")

    def record_status(self, chat_date: str, sending_status: str, extra_time: str, note: str):
        self.status['Ngày giờ gửi tin'] = chat_date
        self.status['Trạng thái gửi tin'] = sending_status
        self.status['Ngày giờ trạng thái (nếu có)'] = extra_time
        self.status['Ghi chú'] = note


class BroadcastNick(ZaloNick):
    ZALO_LOGIN = "https://chat.zalo.me/"
    ZALO_NOT_LOGIN = "https://id.zalo.me/account/login"
    ZALO_BLOCK_STRANGERS = ["BẠN CHƯA THỂ GỬI TIN NHẮN ĐẾN NGƯỜI NÀY VÌ NGƯỜI NÀY CHẶN KHÔNG NHẬN TIN NHẮN TỪ NGƯỜI LẠ.",
                            "KHÔNG THỂ NHẬN TIN NHẮN TỪ BẠN."]
    ZALO_BLOCK_ME = "XIN LỖI! HIỆN TẠI TÔI KHÔNG MUỐN NHẬN TIN NHẮN."
    ZALO_REQUEST_BLOCKING = "Vượt quá số request cho phép"
    ZALO_INVALID_NICK = "Số điện thoại này không hợp lệ"
    ZALO_NOT_ACTIVE_NICK = "Số điện thoại này chưa kích hoạt Zalo"
    ZALO_CLASS_MY_LAST_MESSAGE = ["card me last-msg has-status card--text",
                                  "card me last-msg has-status card--picture",
                                  "card me last-msg has-status card--sticker"]
    ZALO_CLASS_CUSTOMER_LAST_MESSAGE = ["card  pin-react  last-msg card--text",
                                        "card  pin-react  last-msg card--picture",
                                        "card  pin-react  last-msg card--sticker"]
    STATUS_FIELDS_FOR_ACS = ['SĐT khách hàng', 'Ngày giờ gửi tin', 'Trạng thái gửi tin',
                             'Ngày giờ trạng thái (nếu có)', 'Ghi chú', 'SĐT broadcasting',
                             'Tin nhắn phản hồi từ chối', 'Tin nhắn phản hồi khác', 'Tên thương hiệu']
    STATUS_FIELDS_FOR_CUSTOMERS = ['Số ĐT', 'Ghi chú']

    def __init__(self, phone: str, password: str):
        super().__init__(phone=phone)
        self.password = password
        self.driver: webdriver = None
        self._nicks = []

    @property
    def nicks(self):
        return self._nicks

    @nicks.setter
    def nicks(self, nicks: List[ZaloNick]):
        self._nicks = nicks

    def _create_driver(self, chome_driver_path="chromedriver.exe"):
        """ create driver for each profile """
        profile_dir = os.path.join(Path.BOT_ROOT_FOLDER, r"Profiles", self.phone)
        chrome_options = Options()
        chrome_options.add_argument(f"user-data-dir={profile_dir}")
        chrome_options.add_argument("disable-infobars")
        chrome_options.add_argument("launch-simple-driver")
        chrome_options.add_argument("start-maximized")
        chrome_options.add_experimental_option('excludeSwitches', ['enable-automation'])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        driver = webdriver.Chrome(executable_path=chome_driver_path, options=chrome_options)
        return driver

    def login(self):
        self.driver = self._create_driver(ChromeDriver(Path.CHROME_DRIVER_PATH).get_chromedriver())
        self.driver.get(BroadcastNick.ZALO_LOGIN)
        if self.driver.current_url != BroadcastNick.ZALO_LOGIN:
            show_message("THÔNG BÁO", "Bạn cần đăng nhập zalo cho lần đầu tiên", QMessageBox.Warning)
        while self.driver.current_url != BroadcastNick.ZALO_LOGIN:
            pass

    def find_contact(self, nick: ZaloNick):
        try:
            self.driver.find_element_by_id('contact-search-input')
        except NoSuchElementException:
            self.driver.get(BroadcastNick.ZALO_LOGIN)
            time.sleep(1)

        contact = self.driver.find_element_by_id('contact-search-input')
        contact.send_keys(Keys.CONTROL + 'a' + Keys.DELETE)
        contact.send_keys(nick.phone)
        time.sleep(1)
        search_result = self.driver.find_elements_by_class_name("global-search-no-result")
        if search_result:
            nick.contact_found = False
            contact.send_keys((Keys.CONTROL, "a", Keys.DELETE))
            # get respone to check whether be blocked or not
            resp = self.check_blocking_request(nick)
            if resp.upper() == BroadcastNick.ZALO_REQUEST_BLOCKING.upper():
                raise ZaloRequestExceedingException("Đã bị chặn")
            else:
                nick.status['Ghi chú'] = resp
                raise ZaloNotFoundException("Không tìm thấy nick zalo")
        else:
            contact.send_keys(Keys.ENTER)
            time.sleep(1)

    def send_data(self, nick: ZaloNick, message: str, sheetname: str, excel_reader: ExcelReader):
        self.find_contact(nick)
        if message is not None:
            message_input = self.driver.find_element_by_id('richInput')
            pyperclip.copy(message)
            message_input.send_keys(Keys.CONTROL, 'v')
            message_input = self.driver.find_element_by_id('richInput')
            message_input.send_keys(Keys.ENTER)
            time.sleep(1)
        if sheetname is not None:
            message_input = self.driver.find_element_by_id('richInput')
            excel_reader.copy_used_range(sheetname=sheetname)
            message_input.send_keys(Keys.CONTROL, 'v')
            message_input = self.driver.find_element_by_id('richInput')
            message_input.send_keys(Keys.ENTER)
            time.sleep(1)

        while True:
            try:
                self.driver.execute_script("document.getElementsByClassName('btn btn-txt btn-primary btn-modal-action')[0].click()")
            except JavascriptException:
                time.sleep(1)
                pass
            else:
                break

        clear_clipboard()

    def get_status(self, nick: ZaloNick):
        pass

    def check_blocking_request(self, nick: ZaloNick):
        # show form to invite friends
        try:
            self.driver.execute_script('document.querySelector("#inviteBtn > div > i.fa").click()')
            time.sleep(0.5)
            invite_input = self.driver.find_element_by_css_selector('#findFriend > div.flx.flx-center > div > div > input')
            invite_input.send_keys(f"'{str(nick.phone)}'", Keys.ENTER)
            time.sleep(0.5)
            resp = self.driver.execute_script('return document.getElementsByClassName("toast-container")[0].innerText')
            time.sleep(0.5)
            self.driver.execute_script('document.querySelector("#inviteBtn > div > i.fa").click()')
            time.sleep(0.5)
            return str(resp)
        except Exception:
            return ''   # if exception occurs (Ex: no such elem, elem's not clickable,..), we'll consider nick to be blocked

