import os
import sys

from PyQt5 import QtWidgets
from PyQt5.QtWidgets import QMessageBox

import utils.fix_errors.fix_qt_import_error
import utils.fix_errors.logging_uncaught_exception
from business.controller.main_controller import MainController
from business.view.zalo_exploit_group import Execute
from business.service.utils import show_message
from utils.license.license_checker import LicenseChecker, LicenseCode
from utils.parallel_locker import ParallelLoker, TwoProcessRunningAtSameTimeException

if __name__ == "__main__":
    app = QtWidgets.QApplication(sys.argv)
    CHECKER_ENDPOINT = 'http://quatangbaohiem.com/api/bot/authorize?mac='
    license_bot = LicenseChecker(base_url=CHECKER_ENDPOINT, bot_id='zalo_bot_khai_thac_nhom')
    license_status = license_bot.check()
    license_bot.show_status(license_status)
    if license_status == LicenseCode.OK:
        try:
            with ParallelLoker() as p:
                mphone = os.environ.get('MY_PHONE')
                mpass = os.environ.get('MY_PASS')
                nickname = "Le Minh Nguyen"
                execute = Execute(mphone, mpass, nickname)
                return_value = execute.run()
                sys.exit(return_value)
        except TwoProcessRunningAtSameTimeException:
            show_message("Thông báo", "Bạn không được phép chạy 2 chương trình cùng lúc", type_=QMessageBox.Critical)
        except Exception:
            pass
            
